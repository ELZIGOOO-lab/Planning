<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendrier Interactif</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Calendrier">
    
    <!-- FullCalendar CDN -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
    
    <style>
        /* ========================================================================
           STYLES GÉNÉRAUX
           ======================================================================== */
        
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #1f2937;
            margin: 0;
            padding: 1rem;
            min-height: 100vh;
        }
        
        /* ========================================================================
           CONTENEUR PRINCIPAL
           ======================================================================== */
        
        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            backdrop-filter: blur(10px);
            overflow: hidden;
        }
        
        /* ========================================================================
           EN-TÊTE
           ======================================================================== */
        
        .app-header {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }
        
        .app-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .app-subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin: 0.5rem 0 0 0;
        }
        
        /* ========================================================================
           BARRE D'OUTILS
           ======================================================================== */
        
        .toolbar {
            background: white;
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
            justify-content: space-between;
        }
        
        .toolbar-section {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }
        
        .toolbar input, .toolbar select, .toolbar button {
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }
        
        .toolbar input:focus, .toolbar select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .toolbar button {
            background: #3b82f6;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .toolbar button:hover {
            background: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        .toolbar button:active {
            transform: translateY(0);
        }
        
        .btn-secondary {
            background: #6b7280 !important;
        }
        
        .btn-secondary:hover {
            background: #4b5563 !important;
        }
        
        /* ========================================================================
           CALENDRIER
           ======================================================================== */
        
        .calendar-container {
            padding: 2rem;
            background: white;
        }
        
        #calendar {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        /* Personnalisation FullCalendar */
        .fc-header-toolbar {
            padding: 1rem !important;
            background: #f8fafc !important;
            border-bottom: 1px solid #e2e8f0 !important;
        }
        
        .fc-button-primary {
            background: #3b82f6 !important;
            border-color: #3b82f6 !important;
            border-radius: 6px !important;
            font-weight: 500 !important;
        }
        
        .fc-button-primary:hover {
            background: #2563eb !important;
            border-color: #2563eb !important;
        }
        
        .fc-event {
            border-radius: 6px !important;
            border: none !important;
            padding: 2px 6px !important;
            font-weight: 500 !important;
            cursor: pointer !important;
            transition: all 0.2s ease !important;
        }
        
        .fc-event:hover {
            transform: translateY(-1px) !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
        }
        
        .fc-daygrid-day:hover {
            background-color: rgba(59, 130, 246, 0.05) !important;
        }
        
        /* ========================================================================
           MODAL
           ======================================================================== */
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { 
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to { 
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .modal-header {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0;
        }
        
        .close-button {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .close-button:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .modal-body {
            padding: 2rem;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        /* ========================================================================
           FORMULAIRES
           ======================================================================== */
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }
        
        .form-group input, 
        .form-group textarea, 
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }
        
        .form-group input:focus, 
        .form-group textarea:focus, 
        .form-group select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .form-actions {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid #e5e7eb;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);
        }
        
        /* ========================================================================
           NOTIFICATIONS TOAST
           ======================================================================== */
        
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #1f2937;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            z-index: 1001;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
            max-width: 400px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        
        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }
        
        .toast.success {
            background: #10b981;
        }
        
        .toast.error {
            background: #ef4444;
        }
        
        .toast.info {
            background: #3b82f6;
        }
        
        /* ========================================================================
           RESPONSIVE
           ======================================================================== */
        
        @media (max-width: 768px) {
            body {
                padding: 0.5rem;
            }
            
            .app-title {
                font-size: 2rem;
            }
            
            .app-header {
                padding: 1.5rem;
            }
            
            .toolbar {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }
            
            .toolbar-section {
                justify-content: center;
            }
            
            .calendar-container {
                padding: 1rem;
            }
            
            .modal-content {
                margin: 2% auto;
                width: 95%;
            }
            
            .modal-body {
                padding: 1.5rem;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .toast {
                bottom: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
            }
        }
        
        /* ========================================================================
           ACCESSIBILITÉ
           ======================================================================== */
        
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        button:focus-visible, 
        input:focus-visible, 
        select:focus-visible, 
        textarea:focus-visible {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
        }
        
        /* ========================================================================
           ANIMATIONS ET MICRO-INTERACTIONS
           ======================================================================== */
        
        .fade-in {
            animation: fadeIn 0.5s ease;
        }
        
        .bounce-in {
            animation: bounceIn 0.6s ease;
        }
        
        @keyframes bounceIn {
            0% {
                opacity: 0;
                transform: scale(0.3);
            }
            50% {
                opacity: 1;
                transform: scale(1.05);
            }
            70% {
                transform: scale(0.9);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        /* Indicateur de chargement */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- En-tête -->
        <header class="app-header">
            <h1 class="app-title">📅 Calendrier Interactif</h1>
            <p class="app-subtitle">Gérez vos événements du 17 septembre au 31 décembre 2025</p>
        </header>

        <!-- Barre d'outils -->
        <div class="toolbar" role="toolbar" aria-label="Outils du calendrier">
            <div class="toolbar-section">
                <input type="text" id="searchInput" placeholder="🔍 Rechercher des événements..." 
                       aria-label="Rechercher des événements">
                
                <select id="colorFilter" aria-label="Filtrer par couleur">
                    <option value="">🎨 Toutes les couleurs</option>
                    <option value="#3788d8">🔵 Bleu</option>
                    <option value="#28a745">🟢 Vert</option>
                    <option value="#dc3545">🔴 Rouge</option>
                    <option value="#ffc107">🟡 Jaune</option>
                    <option value="#6f42c1">🟣 Violet</option>
                    <option value="#fd7e14">🟠 Orange</option>
                </select>
            </div>
            
            <div class="toolbar-section">
                <button id="exportBtn" class="btn-secondary" aria-label="Exporter les événements">
                    📥 Exporter
                </button>
                
                <button id="importBtn" class="btn-secondary" aria-label="Importer des événements">
                    📤 Importer
                </button>
                <input type="file" id="importFile" accept=".json" style="display: none;" aria-label="Fichier à importer">
                
                <button id="clearAllBtn" class="btn-secondary" aria-label="Effacer tous les événements">
                    🗑️ Tout effacer
                </button>
            </div>
        </div>

        <!-- Calendrier -->
        <div class="calendar-container">
            <div id='calendar' role="application" aria-label="Calendrier des événements"></div>
        </div>
    </div>

    <!-- Modal pour l'édition d'événements -->
    <div id="eventModal" class="modal" role="dialog" aria-labelledby="modalTitle" aria-modal="true">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle" class="modal-title">Ajouter un événement</h3>
                <button class="close-button" aria-label="Fermer la modal">&times;</button>
            </div>
            
            <div class="modal-body">
                <form id="eventForm">
                    <input type="hidden" id="eventId">
                    
                    <div class="form-group">
                        <label for="eventTitle">📝 Titre *</label>
                        <input type="text" id="eventTitle" required aria-required="true" 
                               placeholder="Nom de l'événement">
                    </div>
                    
                    <div class="form-group">
                        <label for="eventDesc">📄 Description</label>
                        <textarea id="eventDesc" placeholder="Description de l'événement..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="eventStart">🕐 Date et heure de début *</label>
                        <input type="datetime-local" id="eventStart" required aria-required="true">
                    </div>
                    
                    <div class="form-group">
                        <label for="eventEnd">🕑 Date et heure de fin *</label>
                        <input type="datetime-local" id="eventEnd" required aria-required="true">
                    </div>
                    
                    <div class="form-group">
                        <label for="eventColor">🎨 Couleur</label>
                        <select id="eventColor">
                            <option value="#3788d8">🔵 Bleu</option>
                            <option value="#28a745">🟢 Vert</option>
                            <option value="#dc3545">🔴 Rouge</option>
                            <option value="#ffc107">🟡 Jaune</option>
                            <option value="#6f42c1">🟣 Violet</option>
                            <option value="#fd7e14">🟠 Orange</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="eventParticipants">👥 Participants</label>
                        <input type="text" id="eventParticipants" 
                               placeholder="Jean, Marie, Pierre... (séparés par des virgules)">
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" id="cancelButton" class="btn btn-secondary">
                            ❌ Annuler
                        </button>
                        <button type="button" id="deleteEventButton" class="btn btn-danger" style="display: none;">
                            🗑️ Supprimer
                        </button>
                        <button type="submit" class="btn btn-primary">
                            💾 Sauvegarder
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Conteneur pour les notifications -->
    <div id="toast-container" aria-live="polite" aria-atomic="true"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // ========================================================================
            // VARIABLES GLOBALES
            // ========================================================================

            let calendar;
            let allEvents = [];
            const STORAGE_KEY = 'calendarEvents';

            // ========================================================================
            // INITIALISATION DE FULLCALENDAR
            // ========================================================================

            const calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                initialDate: '2025-09-17',
                locale: 'fr',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                editable: true,
                selectable: true,
                selectMirror: true,
                dayMaxEvents: true,
                weekends: true,
                events: [],
                
                // Plage de dates valide (17 septembre 2025 au 31 décembre 2025)
                validRange: {
                    start: '2025-09-17',
                    end: '2026-01-01' // Fin exclusive
                },

                // Gestion des événements
                select: function(info) {
                    if (isDateInValidRange(info.start)) {
                        openModal(info);
                    } else {
                        showToast("Vous ne pouvez créer des événements qu'entre le 17 septembre et le 31 décembre 2025.", 'error');
                    }
                },

                eventClick: function(info) {
                    openModal(info.event);
                },

                // Drag & Drop avec validation
                eventDrop: function(info) {
                    if (isDateInValidRange(info.event.start)) {
                        updateEvent(info.event);
                        showToast(`Événement "${info.event.title}" déplacé`, 'success');
                    } else {
                        info.revert();
                        showToast("Impossible de déplacer l'événement en dehors de la période autorisée.", 'error');
                    }
                },

                // Redimensionnement avec validation
                eventResize: function(info) {
                    if (isDateInValidRange(info.event.start) && isDateInValidRange(info.event.end)) {
                        updateEvent(info.event);
                        showToast(`Durée de "${info.event.title}" modifiée`, 'success');
                    } else {
                        info.revert();
                        showToast("Impossible de redimensionner l'événement en dehors de la période autorisée.", 'error');
                    }
                }
            });

            calendar.render();

            // ========================================================================
            // GESTION DE LA PERSISTANCE (LOCALSTORAGE)
            // ========================================================================

            function loadFromLocalStorage() {
                try {
                    const localEvents = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                    allEvents = localEvents;
                    applyFilters();
                    showToast(`${allEvents.length} événements chargés`, 'info');
                } catch (error) {
                    console.error('Erreur de chargement:', error);
                    allEvents = [];
                    showToast('Erreur de chargement des données', 'error');
                }
            }

            function saveToLocalStorage() {
                try {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(allEvents));
                } catch (error) {
                    console.error('Erreur de sauvegarde:', error);
                    showToast('Erreur de sauvegarde des données', 'error');
                }
            }

            function saveEvent(eventData) {
                // Validation des données
                if (!eventData.title || !eventData.start || !eventData.end) {
                    showToast("Veuillez remplir tous les champs obligatoires.", 'error');
                    return;
                }

                // Validation des dates
                const startDate = new Date(eventData.start);
                const endDate = new Date(eventData.end);
                
                if (endDate <= startDate) {
                    showToast("La date de fin doit être postérieure à la date de début.", 'error');
                    return;
                }

                if (!isDateInValidRange(startDate) || !isDateInValidRange(endDate)) {
                    showToast("Les événements doivent être entre le 17 septembre et le 31 décembre 2025.", 'error');
                    return;
                }

                // Ajout de métadonnées
                eventData.lastModified = new Date().toISOString();
                eventData.createdAt = eventData.createdAt || new Date().toISOString();

                if (eventData.id) {
                    // Mise à jour
                    const index = allEvents.findIndex(e => e.id === eventData.id);
                    if (index !== -1) {
                        allEvents[index] = eventData;
                        showToast(`"${eventData.title}" mis à jour`, 'success');
                    }
                } else {
                    // Création
                    eventData.id = Date.now().toString() + Math.random().toString(36).substr(2, 9);
                    allEvents.push(eventData);
                    showToast(`"${eventData.title}" ajouté`, 'success');
                }

                saveToLocalStorage();
                applyFilters();
            }

            function updateEvent(event) {
                const eventData = {
                    id: event.id,
                    title: event.title,
                    start: event.start.toISOString(),
                    end: event.end ? event.end.toISOString() : null,
                    color: event.backgroundColor || event.color,
                    description: event.extendedProps.description || '',
                    participants: event.extendedProps.participants || []
                };
                
                const index = allEvents.findIndex(e => e.id === eventData.id);
                if (index !== -1) {
                    allEvents[index] = { ...allEvents[index], ...eventData };
                    saveToLocalStorage();
                }
            }

            function deleteEvent(eventId) {
                const index = allEvents.findIndex(e => e.id === eventId);
                if (index !== -1) {
                    const eventTitle = allEvents[index].title;
                    allEvents.splice(index, 1);
                    saveToLocalStorage();
                    applyFilters();
                    showToast(`"${eventTitle}" supprimé`, 'success');
                }
            }

            function clearAllEvents() {
                if (confirm('Êtes-vous sûr de vouloir supprimer tous les événements ? Cette action est irréversible.')) {
                    allEvents = [];
                    saveToLocalStorage();
                    applyFilters();
                    showToast('Tous les événements ont été supprimés', 'info');
                }
            }

            // ========================================================================
            // GESTION DE LA MODAL
            // ========================================================================

            const modal = document.getElementById('eventModal');
            const closeButton = document.querySelector('#eventModal .close-button');
            const eventForm = document.getElementById('eventForm');
            const deleteButton = document.getElementById('deleteEventButton');
            const cancelButton = document.getElementById('cancelButton');

            function openModal(data) {
                if (data.id) {
                    // Modification d'un événement existant
                    document.getElementById('modalTitle').innerText = 'Modifier l\'événement';
                    document.getElementById('eventId').value = data.id;
                    document.getElementById('eventTitle').value = data.title;
                    document.getElementById('eventDesc').value = data.extendedProps.description || '';
                    document.getElementById('eventStart').value = formatDateTimeLocal(data.start);
                    document.getElementById('eventEnd').value = data.end ? formatDateTimeLocal(data.end) : '';
                    document.getElementById('eventColor').value = data.backgroundColor || data.color || '#3788d8';
                    document.getElementById('eventParticipants').value = (data.extendedProps.participants || []).join(', ');
                    deleteButton.style.display = 'inline-flex';
                } else {
                    // Création d'un nouvel événement
                    document.getElementById('modalTitle').innerText = 'Ajouter un événement';
                    document.getElementById('eventId').value = '';
                    eventForm.reset();
                    
                    // Définir les dates par défaut
                    const startDate = new Date(data.startStr + 'T12:00');
                    const endDate = new Date(data.endStr ? data.endStr + 'T13:00' : data.startStr + 'T13:00');
                    
                    document.getElementById('eventStart').value = formatDateTimeLocal(startDate);
                    document.getElementById('eventEnd').value = formatDateTimeLocal(endDate);
                    document.getElementById('eventColor').value = '#3788d8';
                    deleteButton.style.display = 'none';
                }
                
                modal.style.display = 'block';
                document.getElementById('eventTitle').focus();
            }

            function closeModal() {
                modal.style.display = 'none';
            }

            // Gestionnaires d'événements pour la modal
            closeButton.onclick = closeModal;
            cancelButton.onclick = closeModal;
            
            window.onclick = (event) => {
                if (event.target === modal) {
                    closeModal();
                }
            };

            // Gestion de l'échappement pour fermer la modal
            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape' && modal.style.display === 'block') {
                    closeModal();
                }
            });

            eventForm.onsubmit = (e) => {
                e.preventDefault();
                
                const eventData = {
                    id: document.getElementById('eventId').value,
                    title: document.getElementById('eventTitle').value.trim(),
                    start: document.getElementById('eventStart').value,
                    end: document.getElementById('eventEnd').value,
                    color: document.getElementById('eventColor').value,
                    description: document.getElementById('eventDesc').value.trim(),
                    participants: document.getElementById('eventParticipants').value
                        .split(',')
                        .map(p => p.trim())
                        .filter(p => p.length > 0)
                };
                
                saveEvent(eventData);
                closeModal();
            };

            deleteButton.onclick = () => {
                const eventId = document.getElementById('eventId').value;
                const eventTitle = document.getElementById('eventTitle').value;
                
                if (confirm(`Êtes-vous sûr de vouloir supprimer l'événement "${eventTitle}" ?`)) {
                    deleteEvent(eventId);
                    closeModal();
                }
            };

            // ========================================================================
            // FILTRAGE ET RECHERCHE
            // ========================================================================

            const searchInput = document.getElementById('searchInput');
            const colorFilter = document.getElementById('colorFilter');

            searchInput.addEventListener('input', applyFilters);
            colorFilter.addEventListener('change', applyFilters);

            function applyFilters() {
                const searchTerm = searchInput.value.toLowerCase();
                const selectedColor = colorFilter.value;

                let filteredEvents = allEvents.filter(event => {
                    // Filtre par texte
                    const matchesSearch = !searchTerm || 
                        event.title.toLowerCase().includes(searchTerm) ||
                        (event.description && event.description.toLowerCase().includes(searchTerm)) ||
                        (event.participants && event.participants.some(p => p.toLowerCase().includes(searchTerm)));

                    // Filtre par couleur
                    const matchesColor = !selectedColor || event.color === selectedColor;

                    return matchesSearch && matchesColor;
                });

                // Mettre à jour le calendrier
                calendar.removeAllEvents();
                calendar.addEventSource(filteredEvents);
            }

            // ========================================================================
            // EXPORT / IMPORT JSON
            // ========================================================================

            const exportBtn = document.getElementById('exportBtn');
            const importBtn = document.getElementById('importBtn');
            const importFile = document.getElementById('importFile');
            const clearAllBtn = document.getElementById('clearAllBtn');

            exportBtn.addEventListener('click', exportEvents);
            importBtn.addEventListener('click', () => importFile.click());
            importFile.addEventListener('change', importEvents);
            clearAllBtn.addEventListener('click', clearAllEvents);

            function exportEvents() {
                if (allEvents.length === 0) {
                    showToast('Aucun événement à exporter', 'info');
                    return;
                }

                const dataStr = JSON.stringify(allEvents, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `calendrier-events-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                showToast(`${allEvents.length} événements exportés`, 'success');
            }

            function importEvents(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedEvents = JSON.parse(e.target.result);
                        
                        if (!Array.isArray(importedEvents)) {
                            throw new Error("Le fichier doit contenir un tableau d'événements");
                        }

                        // Validation et import des événements
                        let importedCount = 0;
                        importedEvents.forEach(eventData => {
                            if (eventData.title && eventData.start && eventData.end) {
                                // Générer un nouvel ID pour éviter les conflits
                                eventData.id = Date.now().toString() + Math.random().toString(36).substr(2, 9);
                                eventData.lastModified = new Date().toISOString();
                                eventData.createdAt = eventData.createdAt || new Date().toISOString();
                                
                                allEvents.push(eventData);
                                importedCount++;
                            }
                        });

                        saveToLocalStorage();
                        applyFilters();
                        showToast(`${importedCount} événements importés avec succès`, 'success');
                    } catch (error) {
                        console.error("Erreur d'import: ", error);
                        showToast("Erreur lors de l'import du fichier", 'error');
                    }
                };
                reader.readAsText(file);
                
                // Reset du champ file
                event.target.value = '';
            }

            // ========================================================================
            // FONCTIONS UTILITAIRES
            // ========================================================================

            function isDateInValidRange(date) {
                const startRange = new Date('2025-09-17');
                const endRange = new Date('2025-12-31T23:59:59');
                const checkDate = new Date(date);
                return checkDate >= startRange && checkDate <= endRange;
            }

            function formatDateTimeLocal(date) {
                const d = new Date(date);
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                const hours = String(d.getHours()).padStart(2, '0');
                const minutes = String(d.getMinutes()).padStart(2, '0');
                return `${year}-${month}-${day}T${hours}:${minutes}`;
            }

            function showToast(message, type = 'info') {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                container.appendChild(toast);
                
                // Animation d'apparition
                setTimeout(() => {
                    toast.classList.add('show');
                }, 100);

                // Animation de disparition
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => {
                        if (container.contains(toast)) {
                            container.removeChild(toast);
                        }
                    }, 300);
                }, 3000);
            }

            // ========================================================================
            // INITIALISATION
            // ========================================================================

            // Charger les événements au démarrage
            loadFromLocalStorage();

            // Message de bienvenue
            setTimeout(() => {
                showToast('Calendrier prêt ! Cliquez sur une date pour ajouter un événement.', 'info');
            }, 1000);
        });
    </script>

</body>
</html>

